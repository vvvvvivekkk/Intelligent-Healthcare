<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Assistant â€“ MedSync AI</title>
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="container">
            <a href="/" class="navbar-brand">
                <svg viewBox="0 0 32 32" fill="none">
                    <rect width="32" height="32" rx="8" fill="#2563eb" />
                    <path d="M16 8v16M8 16h16" stroke="#fff" stroke-width="3" stroke-linecap="round" />
                </svg>
                MedSync AI
            </a>
            <ul class="navbar-nav">
                <li><a href="/patient/dashboard">Dashboard</a></li>
                <li><a href="/patient/chatbot" class="active">AI Chatbot</a></li>
                <li><a href="/patient/appointments">Appointments</a></li>
                <li><a href="/doctors/browse">Find Doctors</a></li>
            </ul>
            <div class="nav-user">
                <span class="nav-user-name" id="userName"></span>
                <button class="btn btn-sm btn-secondary" onclick="API.logout()">Logout</button>
            </div>
        </div>
    </nav>

    <!-- Chatbot -->
    <div class="chatbot-wrapper">
        <div class="chat-header">
            <h2>
                <svg width="24" height="24" viewBox="0 0 32 32" fill="none">
                    <rect width="32" height="32" rx="8" fill="#2563eb" />
                    <path d="M16 8v16M8 16h16" stroke="#fff" stroke-width="2.5" stroke-linecap="round" />
                </svg>
                MedSync AI Assistant
            </h2>
            <div style="display:flex;align-items:center;gap:12px">
                <div class="chat-status">
                    <div class="dot"></div>
                    Online
                </div>
                <button class="btn btn-sm btn-secondary" onclick="startNewSession()">New Chat</button>
            </div>
        </div>

        <div class="chat-messages" id="chatMessages">
            <!-- Welcome message -->
            <div class="chat-bubble assistant">
                <div>Hello! ğŸ‘‹ I'm your <strong>MedSync AI Assistant</strong> â€” powered by advanced AI.</div>
                <div style="margin-top:8px">I can help you with:</div>
                <ul style="margin-top:4px;padding-left:20px">
                    <li>ğŸ¥ Health concerns & symptom guidance</li>
                    <li>ğŸ‹ï¸ Fitness & workout plans</li>
                    <li>ğŸ¥— Nutrition & diet advice</li>
                    <li>ğŸ’» Programming, tech & AI/ML</li>
                    <li>ğŸ“š Education, science & general knowledge</li>
                    <li>ğŸ’¼ Career guidance & business advice</li>
                    <li>ğŸ“… Book appointments with specialists</li>
                    <li>ğŸ’¬ And anything else you want to ask!</li>
                </ul>
                <div style="margin-top:8px"><strong>What can I help you with today? Just ask me anything!</strong>
                </div>
                <div class="timestamp" id="welcomeTimestamp"></div>
                <script>document.getElementById('welcomeTimestamp').textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });</script>
            </div>
        </div>

        <div class="chat-input-area">
            <textarea id="chatInput"
                placeholder="Ask me anything â€” health, programming, career, science, or any topic..." rows="1"
                onkeydown="handleKeyDown(event)"></textarea>
            <button class="chat-send-btn" id="sendBtn" onclick="sendMessage()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="22" y1="2" x2="11" y2="13" />
                    <polygon points="22 2 15 22 11 13 2 9 22 2" />
                </svg>
            </button>
        </div>
    </div>

    <!-- Booking Modal (Step 3: Date & Slot selection) -->
    <div class="modal-overlay hidden" id="bookingModal">
        <div class="modal">
            <div class="modal-header">
                <h3>ğŸ“… Select Date & Time</h3>
                <button class="modal-close" onclick="closeModal('bookingModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="bookingDoctorInfo"></div>
                <div class="form-group mt-2">
                    <label class="form-label">Select Date</label>
                    <input type="date" class="form-input" id="bookingDate" onchange="loadBookingSlots()">
                </div>
                <div class="form-group">
                    <label class="form-label">Available Time Slots</label>
                    <div class="slot-grid" id="bookingSlots">
                        <p class="text-center" style="grid-column:1/-1;color:var(--text-secondary)">Select a date to
                            see available slots</p>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Reason (optional)</label>
                    <input type="text" class="form-input" id="bookingReason" placeholder="e.g. consultation, follow-up">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('bookingModal')">Cancel</button>
                <button class="btn btn-primary" id="confirmBookBtn" onclick="confirmBooking()" disabled>âœ… Confirm
                    Booking</button>
            </div>
        </div>
    </div>

    <!-- Inline styles for interactive booking components -->
    <style>
        /* â”€â”€ Quick Action Buttons â”€â”€ */
        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
            padding: 0 4px;
        }

        .quick-action-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 9px 18px;
            border: 2px solid #2563eb;
            background: rgba(37, 99, 235, 0.06);
            color: #2563eb;
            border-radius: 24px;
            font-size: 0.84rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s ease;
            white-space: nowrap;
        }

        .quick-action-btn:hover {
            background: #2563eb;
            color: #fff;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.3);
        }

        /* â”€â”€ Specialization / Option Pills â”€â”€ */
        .chat-options {
            max-width: 85%;
            margin-top: 6px;
        }

        .chat-options-title {
            font-weight: 600;
            font-size: 0.92rem;
            margin-bottom: 10px;
            color: var(--text);
        }

        .option-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .option-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 18px;
            background: linear-gradient(135deg, #f0f4ff, #e8eeff);
            border: 1.5px solid #c7d2fe;
            border-radius: 12px;
            font-size: 0.84rem;
            font-weight: 500;
            color: #3730a3;
            cursor: pointer;
            transition: all 0.25s ease;
        }

        .option-pill:hover {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: #fff;
            border-color: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(37, 99, 235, 0.3);
        }

        .option-pill .pill-icon {
            font-size: 1.05rem;
        }

        /* â”€â”€ Doctor Selection Cards â”€â”€ */
        .doctor-option-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            background: linear-gradient(135deg, #f8fafc, #f0f4ff);
            border: 1.5px solid #e2e8f0;
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.25s ease;
            margin-bottom: 8px;
        }

        .doctor-option-card:hover {
            border-color: #2563eb;
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(37, 99, 235, 0.15);
        }

        .doctor-option-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .doctor-option-avatar {
            width: 46px;
            height: 46px;
            border-radius: 12px;
            background: linear-gradient(135deg, #2563eb, #7c3aed);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: 700;
            font-size: 1.15rem;
            flex-shrink: 0;
        }

        .doctor-option-name {
            font-weight: 600;
            font-size: 0.92rem;
            color: var(--text);
        }

        .doctor-option-details {
            font-size: 0.78rem;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .doctor-option-rating {
            font-size: 0.84rem;
            color: #f59e0b;
            font-weight: 600;
        }

        .doctor-select-arrow {
            color: #2563eb;
            font-size: 1.3rem;
            font-weight: 700;
            margin-left: 4px;
        }

        /* â”€â”€ Booked / Unavailable Slot Styling â”€â”€ */
        .slot-item.booked {
            background: linear-gradient(135deg, #fef2f2, #fee2e2) !important;
            border-color: #fca5a5 !important;
            color: #991b1b !important;
            cursor: not-allowed !important;
            opacity: 0.7;
            position: relative;
        }

        .slot-item.booked:hover {
            transform: none !important;
            box-shadow: none !important;
        }

        .slot-item.booked .slot-time {
            text-decoration: line-through;
            color: #dc2626 !important;
        }

        .slot-item.booked .booked-label {
            font-size: 0.65rem;
            font-weight: 700;
            color: #dc2626;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
    </style>

    <script src="/js/app.js"></script>
    <script>
        let currentUser = null;
        let sessionId = null;
        let selectedDoctorId = null;
        let selectedSlotId = null;
        let isWaiting = false;

        document.addEventListener('DOMContentLoaded', async () => {
            currentUser = await requireAuth('patient');
            if (!currentUser) return;
            document.getElementById('userName').textContent = currentUser.full_name;

            // Check for session in URL
            const params = new URLSearchParams(window.location.search);
            const existingSession = params.get('session');
            if (existingSession) {
                sessionId = existingSession;
                loadChatHistory(sessionId);
            } else {
                try {
                    const result = await API.post('/api/chatbot/new-session');
                    if (result.success) sessionId = result.data.session_id;
                } catch (e) { }
            }

            // Auto-resize textarea
            const textarea = document.getElementById('chatInput');
            textarea.addEventListener('input', () => {
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            });

            // Set min booking date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('bookingDate').min = tomorrow.toISOString().split('T')[0];

            // Show quick actions after welcome message
            setTimeout(appendQuickActions, 400);
        });


        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  QUICK ACTION BUTTONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function appendQuickActions() {
            // Remove existing quick actions if any
            const existing = document.getElementById('quickActions');
            if (existing) existing.remove();

            const messagesEl = document.getElementById('chatMessages');
            const container = document.createElement('div');
            container.className = 'quick-actions';
            container.id = 'quickActions';
            container.innerHTML = `
                <button class="quick-action-btn" onclick="removeQuickActions(); startBookingFlow();">
                    ğŸ“… Book Appointment
                </button>
                <button class="quick-action-btn" onclick="removeQuickActions(); quickSend('I have a headache and fever');">
                    ğŸ¥ Check Symptoms
                </button>
                <button class="quick-action-btn" onclick="removeQuickActions(); quickSend('Give me a healthy diet plan');">
                    ğŸ¥— Nutrition Advice
                </button>
                <button class="quick-action-btn" onclick="removeQuickActions(); quickSend('Give me a home workout plan');">
                    ğŸ‹ï¸ Fitness Plan
                </button>
            `;
            messagesEl.appendChild(container);
            scrollToBottom();
        }

        function removeQuickActions() {
            const qa = document.getElementById('quickActions');
            if (qa) qa.remove();
        }

        function quickSend(text) {
            document.getElementById('chatInput').value = text;
            sendMessage();
        }


        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  INTERACTIVE BOOKING FLOW (Step-by-step with clickable options)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        async function startBookingFlow() {
            // Step 1: Show specialization options
            appendBubble("ğŸ“… Book Appointment", 'user');
            appendBubble("Let's book an appointment! Please select a specialization below:", 'assistant');

            try {
                const result = await API.get('/api/chatbot/specializations');
                if (result.success && result.data.length > 0) {
                    appendSpecializationOptions(result.data);
                } else {
                    appendBubble('Sorry, no specializations available right now. Please try later.', 'assistant');
                }
            } catch (e) {
                appendBubble('Could not load specializations. Please check your connection.', 'assistant');
            }
            scrollToBottom();
        }

        function appendSpecializationOptions(specializations) {
            const messagesEl = document.getElementById('chatMessages');
            const container = document.createElement('div');
            container.className = 'chat-options';

            const specIcons = {
                'Cardiology': 'â¤ï¸', 'Neurology': 'ğŸ§ ', 'Dermatology': 'ğŸ§´',
                'Orthopedics': 'ğŸ¦´', 'Pediatrics': 'ğŸ‘¶', 'Gastroenterology': 'ğŸ«',
                'Pulmonology': 'ğŸŒ¬ï¸', 'Endocrinology': 'ğŸ§¬', 'Psychiatry': 'ğŸ§˜',
                'Ophthalmology': 'ğŸ‘ï¸', 'ENT': 'ğŸ‘‚', 'General Medicine': 'ğŸ©º'
            };

            container.innerHTML = `
                <div class="chat-options-title">ğŸ¥ Select a Specialization:</div>
                <div class="option-pills">
                    ${specializations.map(spec => `
                        <div class="option-pill" onclick="selectSpecialization('${spec}')">
                            <span class="pill-icon">${specIcons[spec] || 'ğŸ¥'}</span>
                            ${spec}
                        </div>
                    `).join('')}
                </div>
            `;
            messagesEl.appendChild(container);
            scrollToBottom();
        }

        async function selectSpecialization(specialization) {
            // Show user's choice
            appendBubble(specialization, 'user');
            // Remove specialization pills
            removeLastChatOptions();

            appendBubble(`Looking for ${specialization} doctors... ğŸ”`, 'assistant');

            try {
                const result = await API.get(`/api/chatbot/doctors-by-spec?specialization=${encodeURIComponent(specialization)}`);
                // Remove "Looking for..." bubble
                removeLastAssistantBubble();

                if (result.success && result.data.length > 0) {
                    appendBubble(`Found ${result.data.length} ${specialization} doctor(s). Select a doctor:`, 'assistant');
                    appendDoctorOptions(result.data);
                } else {
                    appendBubble(`No ${specialization} doctors available right now. Try another specialization.`, 'assistant');
                }
            } catch (e) {
                removeLastAssistantBubble();
                appendBubble('Could not load doctors. Please try again.', 'assistant');
            }
            scrollToBottom();
        }

        function appendDoctorOptions(doctors) {
            const messagesEl = document.getElementById('chatMessages');
            const container = document.createElement('div');
            container.className = 'chat-options';

            container.innerHTML = `
                <div class="chat-options-title">ğŸ‘¨â€âš•ï¸ Select a Doctor:</div>
                ${doctors.slice(0, 8).map(d => `
                    <div class="doctor-option-card" onclick="selectDoctorFromChat(${d.id}, '${escapeHtml(d.full_name)}', '${d.specialization}')">
                        <div class="doctor-option-info">
                            <div class="doctor-option-avatar">${d.full_name.charAt(0)}</div>
                            <div>
                                <div class="doctor-option-name">${d.full_name}</div>
                                <div class="doctor-option-details">${d.experience_years} yrs exp Â· ${d.hospital || ''}</div>
                            </div>
                        </div>
                        <div style="display:flex;align-items:center;gap:8px">
                            <span class="doctor-option-rating">â­ ${d.rating}</span>
                            <span class="doctor-select-arrow">â€º</span>
                        </div>
                    </div>
                `).join('')}
            `;
            messagesEl.appendChild(container);
            scrollToBottom();
        }

        function selectDoctorFromChat(doctorId, doctorName, specialization) {
            // Show user's selection
            appendBubble(`${doctorName}`, 'user');
            // Remove doctor cards
            removeLastChatOptions();

            appendBubble(`Opening slot picker for **${doctorName}** (${specialization}). Please choose a date and time. ğŸ“†`, 'assistant');

            // Open the booking modal for date/slot selection
            openBooking(doctorId, doctorName, specialization);
        }


        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  HELPER: Remove last options / bubbles
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function removeLastChatOptions() {
            const messagesEl = document.getElementById('chatMessages');
            const options = messagesEl.querySelectorAll('.chat-options');
            if (options.length > 0) options[options.length - 1].remove();
        }

        function removeLastAssistantBubble() {
            const messagesEl = document.getElementById('chatMessages');
            const bubbles = messagesEl.querySelectorAll('.chat-bubble.assistant');
            if (bubbles.length > 0) bubbles[bubbles.length - 1].remove();
        }


        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  CHAT HISTORY & MESSAGING
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        async function loadChatHistory(sessId) {
            try {
                const result = await API.get(`/api/chatbot/history?session_id=${sessId}`);
                if (result.success && result.data.length > 0) {
                    const messagesEl = document.getElementById('chatMessages');
                    result.data.forEach(msg => {
                        appendBubble(msg.message, msg.role, msg.created_at);
                    });
                    scrollToBottom();
                }
            } catch (e) { }
        }

        function handleKeyDown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message || isWaiting) return;

            isWaiting = true;
            input.value = '';
            input.style.height = 'auto';
            document.getElementById('sendBtn').disabled = true;
            removeQuickActions();

            // Add user bubble
            appendBubble(message, 'user');

            // Intercept booking intent locally
            const msgLower = message.toLowerCase();
            if (msgLower.includes('book') && (msgLower.includes('appointment') || msgLower.includes('doctor') || msgLower.includes('slot'))) {
                setTimeout(async () => {
                    appendBubble("Let's book an appointment! Please select a specialization below:", 'assistant');
                    try {
                        const result = await API.get('/api/chatbot/specializations');
                        if (result.success && result.data.length > 0) {
                            appendSpecializationOptions(result.data);
                        }
                    } catch (e) { }
                    isWaiting = false;
                    document.getElementById('sendBtn').disabled = false;
                    scrollToBottom();
                }, 300);
                return;
            }

            // Normal AI message
            showTyping();

            try {
                const result = await API.post('/api/chatbot/message', {
                    message: message,
                    session_id: sessionId
                });

                hideTyping();

                if (result.success) {
                    sessionId = result.data.session_id;
                    appendBubble(result.data.response, 'assistant');

                    if (result.data.analysis) {
                        appendAnalysisCard(result.data.analysis);
                    }
                    if (result.data.recommended_doctors && result.data.recommended_doctors.length > 0) {
                        appendDoctorRecommendations(result.data.recommended_doctors);
                    }
                } else {
                    appendBubble('Sorry, I encountered an error. Please try again.', 'assistant');
                }
            } catch (err) {
                hideTyping();
                appendBubble('Connection error. Please check your connection and try again.', 'assistant');
            }

            isWaiting = false;
            document.getElementById('sendBtn').disabled = false;
            scrollToBottom();
        }


        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  RENDERING HELPERS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function appendBubble(text, role, timestamp) {
            const messagesEl = document.getElementById('chatMessages');
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${role}`;

            const time = timestamp
                ? new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                : new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            let renderedText = text;
            if (role === 'assistant') {
                renderedText = renderMarkdown(text);
            } else {
                renderedText = escapeHtml(text);
            }

            bubble.innerHTML = `<div>${renderedText}</div><div class="timestamp">${time}</div>`;
            messagesEl.appendChild(bubble);
            scrollToBottom();
        }

        function renderMarkdown(text) {
            let html = escapeHtml(text);
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
            html = html.replace(/```json\n?([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
            html = html.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
            html = html.replace(/^- (.*)/gm, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
            html = html.replace(/\n/g, '<br>');
            return html;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showTyping() {
            const messagesEl = document.getElementById('chatMessages');
            const typing = document.createElement('div');
            typing.className = 'chat-typing';
            typing.id = 'typingIndicator';
            typing.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
            messagesEl.appendChild(typing);
            scrollToBottom();
        }

        function hideTyping() {
            const typing = document.getElementById('typingIndicator');
            if (typing) typing.remove();
        }


        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  SYMPTOM ANALYSIS & DOCTOR RECOMMENDATIONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function appendAnalysisCard(analysis) {
            const messagesEl = document.getElementById('chatMessages');
            const card = document.createElement('div');
            card.className = 'analysis-card';
            card.style.maxWidth = '80%';

            const confClass = analysis.confidence_level === 'high' ? 'confidence-high' :
                analysis.confidence_level === 'medium' ? 'confidence-medium' : 'confidence-low';

            card.innerHTML = `
                <h4>ğŸ”¬ AI Health Analysis</h4>
                <div class="analysis-item">
                    <span class="label">Possible Conditions:</span>
                    <span class="value">${analysis.possible_diseases.join(', ')}</span>
                </div>
                <div class="analysis-item">
                    <span class="label">Recommended Specialist:</span>
                    <span class="value">${analysis.recommended_specialization}</span>
                </div>
                <div class="analysis-item">
                    <span class="label">Advice:</span>
                    <span class="value">${analysis.basic_advice}</span>
                </div>
            `;
            messagesEl.appendChild(card);
            scrollToBottom();
        }

        function appendDoctorRecommendations(doctors) {
            const messagesEl = document.getElementById('chatMessages');
            const container = document.createElement('div');
            container.style.maxWidth = '80%';
            container.innerHTML = `
                <div style="margin-top:8px;margin-bottom:8px;font-weight:600;font-size:0.9rem">
                    ğŸ‘¨â€âš•ï¸ Recommended Doctors (${doctors.length} found):
                </div>
                <div class="doctor-rec-list">
                    ${doctors.slice(0, 5).map(d => `
                        <div class="doctor-rec-item">
                            <div>
                                <div style="font-weight:600">${d.full_name}</div>
                                <div style="font-size:0.8rem;color:var(--text-secondary)">
                                    ${d.specialization} Â· ${d.experience_years}yr exp Â· â­ ${d.rating}
                                </div>
                                <div style="font-size:0.75rem;color:var(--text-light)">${d.hospital || ''}</div>
                            </div>
                            <button class="btn btn-sm btn-primary" onclick="openBooking(${d.id}, '${escapeHtml(d.full_name)}', '${d.specialization}')">
                                Book
                            </button>
                        </div>
                    `).join('')}
                </div>
            `;
            messagesEl.appendChild(container);
            scrollToBottom();
        }


        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  BOOKING MODAL (Date & Slot Picker)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function openBooking(doctorId, doctorName, specialization) {
            selectedDoctorId = doctorId;
            selectedSlotId = null;
            document.getElementById('confirmBookBtn').disabled = true;

            document.getElementById('bookingDoctorInfo').innerHTML = `
                <div style="display:flex;align-items:center;gap:12px;padding:16px;background:var(--bg);border-radius:var(--radius-sm)">
                    <div class="doctor-avatar">${doctorName.charAt(0)}</div>
                    <div>
                        <div style="font-weight:600">${doctorName}</div>
                        <span class="doctor-spec">${specialization}</span>
                    </div>
                </div>
            `;
            document.getElementById('bookingSlots').innerHTML = '<p class="text-center" style="grid-column:1/-1;color:var(--text-secondary)">Select a date to view available slots</p>';
            document.getElementById('bookingDate').value = '';
            document.getElementById('bookingReason').value = '';
            document.getElementById('bookingModal').classList.remove('hidden');
        }

        async function loadBookingSlots() {
            const date = document.getElementById('bookingDate').value;
            if (!date) return;

            const slotsEl = document.getElementById('bookingSlots');
            slotsEl.innerHTML = '<div class="spinner" style="grid-column:1/-1"></div>';

            try {
                const result = await API.get(`/api/chatbot/doctor-slots/${selectedDoctorId}?date=${date}`);
                if (result.success) {
                    if (result.data.length === 0) {
                        slotsEl.innerHTML = '<p class="text-center" style="grid-column:1/-1;color:var(--text-secondary)">No slots for this date. Try another date.</p>';
                    } else {
                        slotsEl.innerHTML = result.data.map(s => {
                            const isBooked = s.is_booked === 1;
                            if (isBooked) {
                                return `
                                    <div class="slot-item booked" title="This slot is already booked">
                                        <div class="slot-time">${s.start_time}</div>
                                        <div class="booked-label">Booked</div>
                                    </div>`;
                            } else {
                                return `
                                    <div class="slot-item" data-slot-id="${s.id}" onclick="selectSlot(${s.id}, this)">
                                        <div class="slot-time">${s.start_time}</div>
                                        <div style="font-size:0.7rem;color:var(--text-secondary)">${s.end_time}</div>
                                    </div>`;
                            }
                        }).join('');
                    }
                }
            } catch (e) {
                slotsEl.innerHTML = '<p style="grid-column:1/-1;color:var(--danger)">Failed to load slots</p>';
            }
        }

        function selectSlot(slotId, el) {
            // Prevent selecting booked slots
            if (el.classList.contains('booked')) return;
            document.querySelectorAll('#bookingSlots .slot-item').forEach(s => s.classList.remove('selected'));
            el.classList.add('selected');
            selectedSlotId = slotId;
            document.getElementById('confirmBookBtn').disabled = false;
        }

        async function confirmBooking() {
            if (!selectedDoctorId || !selectedSlotId) return;

            const btn = document.getElementById('confirmBookBtn');
            btn.disabled = true;
            btn.textContent = 'Booking...';

            try {
                const result = await API.post('/api/chatbot/book-from-chat', {
                    doctor_id: selectedDoctorId,
                    slot_id: selectedSlotId,
                    reason: document.getElementById('bookingReason').value || 'Consultation'
                });

                if (result.success) {
                    closeModal('bookingModal');
                    const apt = result.data;
                    appendBubble(
                        `âœ… Appointment booked successfully!\n\n` +
                        `ğŸ“‹ Appointment ID: ${apt.appointment_id}\n` +
                        `ğŸ‘¨â€âš•ï¸ Doctor: ${apt.doctor_name}\n` +
                        `ğŸ“… Date: ${apt.slot_date}\n` +
                        `â° Time: ${apt.start_time} - ${apt.end_time}\n` +
                        `ğŸ†” Patient: ${apt.patient_name} (${apt.patient_code})\n\n` +
                        `View and manage from your **Dashboard**.`,
                        'assistant'
                    );
                    showToast('Appointment booked successfully!', 'success');
                } else {
                    showToast(result.message || 'Booking failed', 'error');
                }
            } catch (e) {
                showToast('Booking failed. Please try again.', 'error');
            }

            btn.disabled = false;
            btn.textContent = 'âœ… Confirm Booking';
        }


        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  SESSION MANAGEMENT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        async function startNewSession() {
            try {
                const result = await API.post('/api/chatbot/new-session');
                if (result.success) {
                    sessionId = result.data.session_id;
                    const messagesEl = document.getElementById('chatMessages');
                    messagesEl.innerHTML = `
                        <div class="chat-bubble assistant">
                            <div>New session started! ğŸš€âœ¨</div>
                            <div style="margin-top:8px"><strong>What can I help you with? Ask me anything â€” I'm here for all your questions!</strong></div>
                            <div class="timestamp">${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
                        </div>
                    `;
                    setTimeout(appendQuickActions, 300);
                    window.history.replaceState({}, '', '/patient/chatbot');
                }
            } catch (e) { }
        }

        function scrollToBottom() {
            const el = document.getElementById('chatMessages');
            el.scrollTop = el.scrollHeight;
        }

        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
        }
    </script>
</body>

</html>